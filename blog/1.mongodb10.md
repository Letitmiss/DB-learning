
# MongoDB主从复制和副本集

http://www.cnblogs.com/yujon/p/

* 主从复制是一个简单的数据库同步备份的集群技术    
1. 在数据库集群中要明确的知道谁是主服务器,主服务器只有一台.
2. 从服务器要知道自己的数据源也就是对于的主服务是谁.
3. --master用来确定主服务器,--slave 和 –source 来控制从服务器

## 集群搭建

### 1主1从

* 主服务器8888端口 mongdb.conf 
```
port = 8888
dbpath = data/8888
logpath = log/8888/mongod.log
fork = true
bind_ip=127.0.0.1
master=true

```
* 从服务器7777端口 mongdbslave.conf 
```
port = 7777
dbpath = data/7777
logpath = log/7777/mongod.log
fork = true
bind_ip=127.0.0.1
source=127.0.0.1:8888
slave=true
```

* 启动服务
```
lfg1000708004:/home/mongodb-3.4.10 # ./bin/mongod -f ./conf/mongdb.conf 
about to fork child process, waiting until server is ready for connections.
forked process: 10694
child process started successfully, parent exiting


lfg1000708004:/home/mongodb-3.4.10 # ./bin/mongod -f ./conf/mongdbslave.conf 
about to fork child process, waiting until server is ready for connections.
forked process: 13591
child process started successfully, parent exiting
```
* shell登陆
```
lfg1000708004:/home/mongodb-3.4.10 # ./bin/mongo 127.0.0.1:8888/test
MongoDB shell version v3.4.10
connecting to: mongodb://127.0.0.1:8888/test
MongoDB server version: 3.4.10
MongoDB Enterprise > show dbs
admin  0.000GB
local  0.000GB
MongoDB Enterprise > use gc
switched to db gc
MongoDB Enterprise > db.persons.insert({_id:"1", name:"name1"})
WriteResult({ "nInserted" : 1 })
MongoDB Enterprise > db.getMongo().setSlaveOk()  # 主库设置SlaveOk()



#从库
lfg1000708004:/home/mongodb-3.4.10 # ./bin/mongo 127.0.0.1:7777/test
MongoDB shell version v3.4.10
connecting to: mongodb://127.0.0.1:7777/test
MongoDB server version: 3.4.10
MongoDB Enterprise > show dbs
2017-12-05T12:52:24.561+0800 E QUERY    [thread1] Error: listDatabases failed:{
	"ok" : 0,
	"errmsg" : "not master and slaveOk=false",
	"code" : 13435,
	"codeName" : "NotMasterNoSlaveOk"
} 
MongoDB Enterprise > db.getMongo().setSlaveOk()  #设置SlaveOK
MongoDB Enterprise > show dbs    # 从服务器自动复制了主服务器的数据库
admin  0.000GB
gc     0.000GB
local  0.000GB
MongoDB Enterprise > use gc             
switched to db gc
MongoDB Enterprise > db.persons.find()
{ "_id" : "1", "name" : "name1" }

MongoDB Enterprise > db.persons.insert({ "_id" : "2", "name" : "name2" })   # 从节点不允许write
WriteResult({ "writeError" : { "code" : 10107, "errmsg" : "not master" } })


# 从节点查询信息
MongoDB Enterprise > use local
switched to db local
MongoDB Enterprise > db.sources.find()
{ "_id" : ObjectId("5a26156a36fb47db5885b474"), "host" : "127.0.0.1:8888", "source" : "main", "syncedTo" : Timestamp(1512450388, 1) }
```

* shell加载从
1. 在启动文件中没有配置source启动项
```
在local中主动添加,挂上从服务器,自动主从复制
MongoDB Enterprise > db.sources.insert({host:"127.0.0.1:8888"})


db.printReplicationInfo(): //查看主节点的信息

db.printSlaveReplicationInfo(): //查看从节点的信息
```


* 其他配置
1. --only  从节点 指定复制某个数据库,默认是复制全部数据库
2. --slavedelay  从节点设置主数据库同步数据的延迟(单位是秒)
3. --fastsync 从节点以主数据库的节点快照为节点启动从数据库
4. --autoresync 从节点如果不同步则从新同步数据库
5. --oplogSize  主节点设置oplog的大小(主节点操作记录存储到local的oplog中)



### 利用shell




